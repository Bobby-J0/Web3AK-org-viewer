<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Web3AK 조직도</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://unpkg.com/gojs@2.3.11/release/go.js"></script>
    <style>
        /* [1] 뷰어 및 기본 레이아웃 */
        #orgChartDiv {
            width: 100%;
            height: 85vh; /* 뷰어 높이 설정 */
            background-color: #FAFAFA;
            border: 1px solid #ccc;
        }
        body { 
            font-family: Arial, sans-serif; 
            text-align: center;
            margin: 0; 
            padding: 0;
            position: relative; 
        }
        
        /* [2] 노드 상세 정보 (수정됨: 좌측 상단, top: 70px) */
        .node-info { 
            position: absolute; 
            top: 70px; /* 상세 정보 박스 위치 상단 조정 */
            left: 10px; /* 좌측 상단으로 배치 */
            max-width: 380px; 
            text-align: left; 
            
            padding: 15px;
            border: 1px solid #ddd; 
            background-color: rgba(255, 255, 255, 0.95); 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 100; 
        }
        .node-info p {
            word-wrap: break-word; 
            word-break: break-all;
        }
        
        /* [3] 기능 안내 박스 (수정됨: 우측 상단, top: 95px) */
        .feature-info {
            position: absolute; 
            top: 95px; /* 기능 박스 위치 */
            right: 40px; /* 우측 상단으로 배치 */
            max-width: 400px; 
            text-align: left; 
            
            padding: 15px; 
            border: 1px solid #ccc; 
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 100;
            
            font-size: 13px;
            
            /* 토글을 위한 기본 숨김 설정 */
            display: none;
        }
        .feature-info.active {
            display: block; /* 활성화 시 노출 */
        }
        .feature-info ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 0;
        }
        .feature-info li {
            margin-bottom: 5px;
        }
        
        /* [4] 검색 UI 스타일 */
        .search-container {
            margin-top: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        #searchInput {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 300px; 
        }
        .search-container button {
            padding: 8px 15px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px; 
        }
        #featureToggleButton {
            background-color: #f8f9fa;
            color: #212529; 
            border: 1px solid #ccc;
        }
        #clearSearchButton {
            background-color: #6c757d;
        }
        #searchButton {
            background-color: #007bff;
        }
        
        /* 버튼 hover 효과 */
        #searchButton:hover { background-color: #0056b3; }
        #clearSearchButton:hover { background-color: #5a6268; }
        #featureToggleButton:hover { background-color: #e2e6ea; }

        /* [5] 모바일 최적화 */
        @media (max-width: 600px) {
            h2 { font-size: 1.2em; margin-bottom: 5px;}
            #orgChartDiv { height: 75vh; }

            /* 검색 UI 모바일 최적화 */
            .search-container {
                margin: 10px 10px 5px 10px;
                display: flex;
                flex-direction: column; 
            }
            #searchInput {
                width: 100%;
                margin-bottom: 5px; 
                box-sizing: border-box;
            }
            .button-row {
                display: flex;
                justify-content: space-between;
                width: 100%;
                margin-bottom: 5px;
            }
            .search-container button {
                flex-grow: 1; 
                width: 31%; 
                margin-left: 0 !important;
                margin-right: 2%; 
            }
            .search-container button:last-child {
                margin-right: 0;
            }
            
            /* 노드 상세 정보 (모바일 상단으로 고정) */
            .node-info { 
                position: static; 
                max-width: 100%; 
                padding: 10px;
                box-shadow: none; 
                border-left: none;
                border-right: none;
                margin: 5px 0 0 0;
            }

            /* 기능 안내 (모바일 뷰 위에 겹치도록 고정) */
            .feature-info {
                position: fixed; 
                top: 50px; 
                left: 5%; 
                width: 90%; 
                max-width: 90%; 
                height: auto;
                max-height: 80vh;
                overflow-y: auto; 
                z-index: 200; 
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            }
        }
    </style>
</head>
<body>
    <h2>Web3AK 조직도</h2>
    
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="이름, 연락처, 지갑주소 (부분 일치 검색)">
        <div class="button-row">
            <button id="featureToggleButton">기능</button>
            <button id="clearSearchButton">Clear</button>
            <button id="searchButton" onclick="highlightNodes()">검색</button>
        </div>
    </div>

    <div class="feature-info" id="featureInfo">
        <h3>🚀 웹 앱 핵심 기능</h3>
        <ul>
            <li>**데이터 연동:** Google Sheets 데이터 실시간 자동 반영</li>
            <li>**노드 상세:** 클릭 시 상세 정보 표시</li>
            <li>**검색:** 이름/연락처/지갑주소로 입력 즉시 노드 자동 강조 (부분 일치)</li>
            <li>**검색 초기화:** ESC 키 또는 'Clear' 버튼으로 검색 초기화 가능</li>
            <li>**기본 조작:** 조직도 이동 및 확대/축소 (키보드 + 마우스 휠)</li>
        </ul>
    </div>

    <div class="node-info" id="selectedNodeInfo">노드를 선택하면 상세 정보가 표시됩니다.</div>

    <div id="orgChartDiv"></div>

    <script>
        // Google Apps Script 웹 앱 URL (데이터 API 엔드포인트)
        const API_URL = "https://script.google.com/macros/s/AKfycbyiqN24ws77h9-DgeN3LkuEiK39azcSZXsS6_L8S_UvvcwUJmY0b-2wLK_xzKtmmNqRlQ/exec"; 
        const $ = go.GraphObject.make; 
        
        let myDiagram = null; 
        
        function init() {
            myDiagram =
                $(go.Diagram, "orgChartDiv", 
                {
                    layout: $(go.TreeLayout, 
                                { angle: 90, nodeSpacing: 10, layerSpacing: 50 }),
                    "undoManager.isEnabled": true, 
                    "click": function(e) {
                        document.getElementById("selectedNodeInfo").innerHTML = "노드를 선택하면 상세 정보가 표시됩니다.";
                        closeFeatureInfo(e);
                    }
                });

        // 노드 템플릿 정의
        myDiagram.nodeTemplate = 
            $(go.Node, "Auto",
                { selectionAdornmentTemplate: nodeSelectionAdornmentTemplate },
                new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                {
                    click: function(e, node) {
                        showNodeDetails(node.data);
                        closeFeatureInfo(e); 
                    }
                },
                // 노드 배경 도형 (RoundedRectangle)
                $(go.Shape, "RoundedRectangle",
                    { name: "shapeElement", strokeWidth: 2, stroke: "#224488" },
                    
                    new go.Binding("fill", "isHighlighted", function(h, shape) {
                        if (h) return "#A9A9A9"; 
                        return shape.part.data.isRoot ? "#ff9933" : "#66bb6a"; 
                    })
                ),
                
                // 노드 텍스트 (유저 정보)
                $(go.TextBlock, "Default Info",
                    { 
                        margin: 8, 
                        font: "bold 14pt Arial, sans-serif",
                        stroke: "white", 
                        textAlign: "center" 
                    },
                    new go.Binding("text", "", function(data) {
                        const name = data.유저_이름 || '이름 없음';
                        const userId = data.유저_ID;
                        let totalCountLine = "";
                        if (data.총_하위_수 && data.총_하위_수 > 0) {
                            totalCountLine = `\n(총 ${data.총_하위_수}명)`;
                        }
                        return `${name}\n${userId}${totalCountLine}`; 
                    })
                )
            );

            // 링크 템플릿 정의
            myDiagram.linkTemplate = 
                $(go.Link, go.Link.Orthogonal, { corner: 5 },
                    $(go.Shape, { strokeWidth: 1.5, stroke: "#555" }));
            
            // API에서 데이터 로드 및 차트 구성 시작
            fetchDataAndBuildChart(myDiagram);
            
            // --- [JS 로직: 검색 및 토글 통합] ---
            const searchInput = document.getElementById('searchInput');
            const clearButton = document.getElementById('clearSearchButton');
            const featureToggleButton = document.getElementById('featureToggleButton');
            const featureInfoDiv = document.getElementById('featureInfo');

            searchInput.addEventListener('keyup', highlightNodes); 

            function clearSearchAndUnhighlight() {
                searchInput.value = '';
                highlightNodes(); 
            }

            // ESC 키 이벤트 리스너
            searchInput.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' || event.keyCode === 27) {
                    event.preventDefault(); 
                    clearSearchAndUnhighlight();
                    closeFeatureInfo(); 
                }
            });

            // Clear 버튼 클릭 이벤트 리스너
            clearButton.addEventListener('click', function() {
                clearSearchAndUnhighlight();
                searchInput.focus();
                closeFeatureInfo(); 
            });

            // 기능 안내 팝업을 닫는 함수
            function closeFeatureInfo() {
                featureInfoDiv.classList.remove('active');
            }

            // '기능' 버튼 클릭 이벤트 리스너
            featureToggleButton.addEventListener('click', function() {
                featureInfoDiv.classList.toggle('active');
            });

            // 팝업 외부 클릭 시 닫히는 로직
            document.body.addEventListener('click', function(event) {
                const target = event.target;
                if (featureInfoDiv.contains(target) || target === featureToggleButton) {
                    return;
                }
                if (featureInfoDiv.classList.contains('active')) {
                    closeFeatureInfo();
                }
            });
            // --- [JS 로직 통합 종료] ---
        }

        // 구글 시트 API에서 데이터를 가져와 GoJS 모델을 구성하고 초기 뷰를 설정하는 함수
        function fetchDataAndBuildChart(diagram) {
            fetch(API_URL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("API 호출 실패: " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!Array.isArray(data) || data.length === 0) {
                        const message = data.length === 0 
                            ? `**경고:** API 통신은 성공했으나, Google Sheets에 노드를 생성할 **데이터 행이 하나도 없습니다.**`
                            : `API 응답 형식이 올바르지 않습니다. (배열이 아님)`;
                        document.getElementById("orgChartDiv").innerHTML = `<p style="color: orange; padding: 20px;">${message}</p>`;
                        return;
                    }

                    // JSON 데이터를 GoJS 모델 형식으로 변환
                    const nodeDataArray = data.map(item => ({
                        key: item['본인_지갑_주소'], 
                        parent: item['상위_노드_지갑_주소'], 
                        유저_이름: item['유저_이름'] || item['유저_ID'],
                        유저_ID: item['유저_ID'],
                        연락처: item['연락처'],
                        본인_지갑_주소: item['본인_지갑_주소'],
                        직속_하위_수: item['직속_하위_수'],
                        총_하위_수: item['총_하위_수'],
                        isRoot: item['상위_노드_지갑_주소'] === "", // 최상위 노드 식별자
                        isHighlighted: false 
                    })).filter(item => item.key); 

                    // 1. 다이어그램 모델 업데이트
                    diagram.model = $(go.TreeModel, { nodeDataArray: nodeDataArray });
                    
                    // 2. 🚨 초기 뷰 확대 로직 시작 (최상위 노드 및 1 Level 자식 기준)
                    diagram.requestUpdate(function() {
                        if (diagram.nodes.count === 0) return;

                        diagram.startTransaction("Initial Root Zoom");

                        // isRoot: true 인 노드를 찾습니다.
                        const rootData = diagram.model.nodeDataArray.find(d => d.isRoot);
                        if (!rootData) {
                            diagram.centerPart(diagram.nodes.iterator.value);
                            diagram.commitTransaction("Initial Root Zoom");
                            return;
                        }

                        const rootNode = diagram.findNodeForKey(rootData.key);
                        if (!rootNode) return;

                        // Root Node와 그 직속 자식 노드들만 포함하는 집합을 생성합니다.
                        const initialGroup = new go.Set();
                        initialGroup.add(rootNode);
                        rootNode.findTreeChildrenNodes().each(child => {
                            // 이 자식 노드가 루트의 직속 자식인지 확인 (레벨 1)
                            if (child.data.parent === rootNode.data.key) {
                                initialGroup.add(child);
                            }
                        });
                        
                        if (initialGroup.count > 0) {
                            // 이 노드들의 경계 (Bounds) 계산
                            const bounds = diagram.computeBounds(initialGroup);
                            
                            // 계산된 경계를 뷰포트로 설정 (적절한 여백을 위해 10% 축소/확대)
                            diagram.setViewportBounds(bounds, diagram.scale * 1.1);
                        } else {
                            // 직속 자식 노드가 없는 경우 루트 노드만 중앙에 배치
                            diagram.centerPart(rootNode);
                        }
                        
                        diagram.commitTransaction("Initial Root Zoom");
                    });
                    // 🚨 초기 뷰 확대 로직 종료
                })
                .catch(error => {
                    console.error("데이터 로드 중 오류 발생:", error);
                    document.getElementById("orgChartDiv").innerHTML = `<p style="color: red; padding: 20px;">**데이터 로드 오류:** API URL(${API_URL})을 확인하거나, Apps Script가 "모든 사용자"에게 공개되었는지 확인하세요. ${error.message}</p>`;
                });
        }

        // 노드 클릭 시 상세 정보를 표시하는 함수
        function showNodeDetails(data) {
            const detailsDiv = document.getElementById("selectedNodeInfo");
            detailsDiv.innerHTML = `
                <h3>${data.유저_이름} (${data.유저_ID})</h3>
                <p><strong>본인 지갑:</strong> ${data.본인_지갑_주소}</p>
                <p><strong>상위 지갑:</strong> ${data.parent || '없음 (루트)'}</p>
                <p><strong>연락처:</strong> ${data.연락처}</p>
                <p><strong>직속 하위:</strong> ${data.직속_하위_수}명, <strong>총 하위 조직:</strong> ${data.총_하위_수}명</p>
            `;
        }
        
        // 실시간 검색 강조 함수
        function highlightNodes() {
            if (!myDiagram || !myDiagram.model) return;
            
            const searchInput = document.getElementById('searchInput');
            const searchText = searchInput.value.toLowerCase().trim();
            const model = myDiagram.model;
            let firstFoundNode = null; 

            myDiagram.startTransaction("highlight search results");

            model.nodeDataArray.forEach(data => {
                const name = (data.유저_이름 || '').toLowerCase();
                const userId = (data.유저_ID || '').toLowerCase();
                const contact = (data.연락처 || '').toLowerCase();
                const wallet = (data.본인_지갑_주소 || '').toLowerCase();
                
                let matches = false;

                if (searchText.length > 0) {
                    if (name.includes(searchText) || userId.includes(searchText) || contact.includes(searchText) || wallet.includes(searchText)) {
                        matches = true;
                    }
                }
                
                if (data.isHighlighted !== matches) {
                    model.setDataProperty(data, "isHighlighted", matches);
                }
                
                if (matches && !firstFoundNode) {
                    firstFoundNode = myDiagram.findNodeForKey(data.key);
                }
            });
            
            myDiagram.commitTransaction("highlight search results");
            
            if (firstFoundNode) {
                myDiagram.centerPart(firstFoundNode);
                firstFoundNode.isSelected = true;
                showNodeDetails(firstFoundNode.data);
            } else {
                myDiagram.clearSelection();
                document.getElementById("selectedNodeInfo").innerHTML = "노드를 선택하면 상세 정보가 표시됩니다.";
            }
        }

        // 노드 선택 시 표시되는 테두리 디자인 정의 (Adornment)
        const nodeSelectionAdornmentTemplate =
            $(go.Adornment, "Auto",
                $(go.Shape, "RoundedRectangle",
                    { fill: null, stroke: "dodgerblue", strokeWidth: 3 }),
                $(go.Placeholder)
            );

        // HTML 문서 로드가 완료된 후 init 함수 실행
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
