<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Web3AK: 실시간 Web3 유저 관계 분석 & 조직도</title>
    <script src="https://unpkg.com/gojs@2.3.11/release/go.js"></script>
    <style>
        /* [1] 뷰어 및 기본 레이아웃 */
        #orgChartDiv {
            width: 100%;
            height: 85vh; /* 뷰어 높이 설정 */
            background-color: #FAFAFA;
            border: 1px solid #ccc;
        }
        body { 
            font-family: Arial, sans-serif; 
            text-align: center;
            margin: 0; 
            padding: 0;
            position: relative; 
        }
        
        /* [2] 노드 상세 정보 (우측 상단) */
        .node-info { 
            position: absolute; 
            /* ✅ 수정: 기존 55px에서 95px (40px 증가)로 조정하여 아래로 내림 */
            top: 95px; 
            right: 40px; 
            max-width: 380px; 
            text-align: left; 
            
            padding: 15px; 
            border: 1px solid #ddd; 
            background-color: rgba(255, 255, 255, 0.95); 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 100; 
        }
        
        /* [3] 기능 안내 박스 (좌측 상단) */
        .feature-info {
            position: absolute; 
            /* ✅ 수정: 기존 55px에서 95px (40px 증가)로 조정하여 아래로 내림 */
            top: 95px; 
            left: 40px; 
            max-width: 380px; 
            text-align: left; 
            
            padding: 15px; 
            border: 1px solid #ccc; 
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 100;
            
            font-size: 13px;
        }
        .feature-info ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 0;
        }
        .feature-info li {
            margin-bottom: 5px;
        }
        
        /* [4] 검색 UI 스타일 */
        .search-container {
            margin-top: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        #searchInput {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 250px;
        }
        .search-container button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .search-container button:hover {
            background-color: #0056b3;
        }
        
    </style>
</head>
<body>
    <h2>Web3AK | 실시간 조직도 뷰어 & 관계 분석 엔진</h2>
    
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="이름, 연락처, 지갑주소 4자리 검색">
        <button onclick="searchAndLocateNode()">검색</button>
    </div>

    <div class="feature-info">
        <h3>🚀 웹 앱 핵심 기능</h3>
        <ul>
            <li>**데이터 연동:** Google Sheets 데이터 실시간 자동 반영</li>
            <li>**노드 상세:** 클릭 시 우측 상단에 지갑 주소 등 상세 정보 표시</li>
            <li>**기본 조작:** 조직도 확대/축소 및 이동</li>
            <li>**검색 기능:** 이름/연락처/지갑주소로 검색하여 노드 자동 찾기</li>
        </ul>
    </div>

    <div class="node-info" id="selectedNodeInfo">노드를 선택하면 상세 정보가 표시됩니다.</div>

    <div id="orgChartDiv"></div>

    <script>
        // Google Apps Script 웹 앱 URL (데이터 API 엔드포인트)
        const API_URL = "https://script.google.com/macros/s/AKfycbyiqN24ws77h9-DgeN3LkuEiK39azcSZXsS6_L8S_UvvcwUJmY0b-2wLK_xzKtmmNqRlQ/exec"; 
        // GoJS 객체 생성을 위한 약식 정의
        const $ = go.GraphObject.make; 
        
        let myDiagram = null; 
        
        function init() {
            // 다이어그램 초기화
            myDiagram =
                $(go.Diagram, "orgChartDiv", 
                {
                    initialAutoScale: go.Diagram.Uniform, // 초기 로드 시 모든 노드가 보이도록 자동 스케일 조정
                    layout: $(go.TreeLayout, // 조직도(Tree) 레이아웃 설정
                                { angle: 90, nodeSpacing: 10, layerSpacing: 50 }),
                    "undoManager.isEnabled": true, // 실행 취소 기능 활성화
                    "click": function(e) {
                        // 빈 공간 클릭 시 상세 정보 초기화
                        document.getElementById("selectedNodeInfo").innerHTML = "노드를 선택하면 상세 정보가 표시됩니다.";
                    }
                });

        // 노드 템플릿 정의: 각 유저 박스의 디자인과 동작 설정
        myDiagram.nodeTemplate = 
            $(go.Node, "Auto",
                { selectionAdornmentTemplate: nodeSelectionAdornmentTemplate },
                // 노드 위치 바인딩
                new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                {
                    // 노드 클릭 이벤트
                    click: function(e, node) {
                        showNodeDetails(node.data);
                    }
                },
                // 노드 배경 도형 (RoundedRectangle)
                // ✅ 수정: shapeElement 이름을 부여하여 검색 강조 기능에서 활용
                $(go.Shape, "RoundedRectangle",
                    { name: "shapeElement", fill: "#3366cc", stroke: "#224488", strokeWidth: 2 },
                    // 루트 노드(상위 노드 없음)인 경우 다른 색상 적용 (isRoot 바인딩)
                    new go.Binding("fill", "isRoot", function(isRoot) { return isRoot ? "#ff9933" : "#66bb6a"; })),
                
                // 노드 텍스트 (유저 정보)
                $(go.TextBlock, "Default Info",
                    { 
                        margin: 8, 
                        font: "bold 14pt Arial, sans-serif",
                        stroke: "white", 
                        textAlign: "center" 
                    },
                    // 데이터 바인딩: 표시할 텍스트 구성
                    new go.Binding("text", "", function(data) {
                        const name = data.유저_이름 || '이름 없음';
                        const userId = data.유저_ID;
                        
                        let totalCountLine = "";
                        // 총 하위 수가 있으면 줄바꿈과 함께 표시
                        if (data.총_하위_수 && data.총_하위_수 > 0) {
                            totalCountLine = `\n(총 ${data.총_하위_수}명)`;
                        }

                        return `${name}\n${userId}${totalCountLine}`; 
                    })
                )
            );

            // 링크 템플릿 정의: 노드들을 잇는 선의 디자인 설정
            myDiagram.linkTemplate = 
                $(go.Link, go.Link.Orthogonal, { corner: 5 },
                    $(go.Shape, { strokeWidth: 1.5, stroke: "#555" }));
            
            // API에서 데이터 로드 및 차트 구성 시작
            fetchDataAndBuildChart(myDiagram);
            
            // 검색창에 keyup 이벤트 바인딩 (Enter 키 감지)
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchAndLocateNode();
                }
            });
        }

        // 구글 시트 API에서 데이터를 가져와 GoJS 모델을 구성하는 함수
        function fetchDataAndBuildChart(diagram) {
            fetch(API_URL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("API 호출 실패: " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!Array.isArray(data)) {
                        throw new Error("API 응답 형식이 올바르지 않습니다.");
                    }
                    
                    // JSON 데이터를 GoJS 모델 형식으로 변환
                    const nodeDataArray = data.map(item => ({
                        key: item['본인_지갑_주소'], // 각 노드의 고유 키 (지갑 주소)
                        parent: item['상위_노드_지갑_주소'], // 부모 노드의 키
                        유저_이름: item['유저_이름'] || item['유저_ID'],
                        유저_ID: item['유저_ID'],
                        연락처: item['연락처'],
                        본인_지갑_주소: item['본인_지갑_주소'],
                        직속_하위_수: item['직속_하위_수'],
                        총_하위_수: item['총_하위_수'],
                        isRoot: item['상위_노드_지갑_주소'] === "" // 최상위 노드 여부
                    })).filter(item => item.key); // key가 없는 데이터는 제외

                    // 다이어그램 모델 업데이트
                    diagram.model = $(go.TreeModel, { nodeDataArray: nodeDataArray });
                })
                .catch(error => {
                    // 오류 발생 시 콘솔에 출력 및 뷰어 영역에 메시지 표시
                    console.error("데이터 로드 중 오류 발생:", error);
                    document.getElementById("orgChartDiv").innerHTML = `<p style="color: red; padding: 20px;">데이터 로드 오류: API URL(${API_URL})을 확인하거나, Apps Script가 "모든 사용자"에게 공개되었는지 확인하세요. ${error.message}</p>`;
                });
        }

        // 노드 클릭 시 우측 상단에 상세 정보를 표시하는 함수
        function showNodeDetails(data) {
            const detailsDiv = document.getElementById("selectedNodeInfo");
            detailsDiv.innerHTML = `
                <h3>${data.유저_이름} (${data.유저_ID})</h3>
                <p><strong>본인 지갑:</strong> ${data.본인_지갑_주소}</p>
                <p><strong>상위 지갑:</strong> ${data.parent || '없음 (루트)'}</p>
                <p><strong>연락처:</strong> ${data.연락처}</p>
                <p><strong>직속 하위:</strong> ${data.직속_하위_수}명, <strong>총 하위 조직:</strong> ${data.총_하위_수}명</p>
            `;
        }
        
        // 검색 기능을 수행하고 해당 노드를 찾아 이동 및 강조하는 함수
        function searchAndLocateNode() {
            if (!myDiagram) return; // 다이어그램이 없으면 함수 종료
            const searchInput = document.getElementById('searchInput');
            const searchText = searchInput.value.toLowerCase().trim();

            if (searchText === "") {
                myDiagram.clearSelection(); // 검색어가 없으면 선택 해제
                return;
            }

            myDiagram.clearSelection(); // 기존 선택 해제
            
            // 노드 데이터 배열을 순회하며 검색어와 일치하는 노드 찾기
            const foundNodeData = myDiagram.model.nodeDataArray.find(data => {
                const name = (data.유저_이름 || '').toLowerCase();
                const userId = (data.유저_ID || '').toLowerCase();
                const contact = (data.연락처 || '').toLowerCase();
                const wallet = (data.본인_지갑_주소 || '').toLowerCase();
                
                // 이름, ID, 연락처에 포함되는지 확인
                if (name.includes(searchText) || userId.includes(searchText) || contact.includes(searchText)) {
                    return true;
                }
                
                // 지갑 주소의 끝 4자리가 일치하는지 확인
                if (searchText.length === 4 && wallet.endsWith(searchText)) {
                    return true;
                }
                
                return false;
            });

            if (foundNodeData) {
                const node = myDiagram.findNodeForKey(foundNodeData.key); // 키로 노드 객체 찾기
                if (node) {
                    // 1. 노드를 화면 중앙으로 이동 (가장 명확한 액션)
                    myDiagram.centerPart(node);
                    
                    // 2. 노드 선택 (파란색 테두리 표시)
                    node.isSelected = true;
                    
                    // 3. 상세 정보 표시
                    showNodeDetails(foundNodeData);
                    
                    // 4. ✅ 추가: 시각적 강조 효과 (빨간색 깜빡임)
                    const shape = node.findObject("shapeElement"); // 템플릿에서 이름으로 Shape 객체 찾기
                    if (shape) {
                        const originalFill = shape.fill;
                        // 임시로 빨간색으로 변경하여 검색 성공을 명확하게 알림
                        shape.fill = "red";
                        
                        // 0.5초(500ms) 후 원래 색상으로 복구
                        setTimeout(() => {
                            shape.fill = originalFill;
                            node.updateTargetBindings(); 
                        }, 500);
                    }
                }
            } else {
                // 노드를 찾지 못한 경우 경고창 표시
                alert(`"${searchInput.value}"에 해당하는 유저를 찾을 수 없습니다.`);
            }
        }

        // 노드 선택 시 표시되는 테두리 디자인 정의 (Adornment)
        const nodeSelectionAdornmentTemplate =
            $(go.Adornment, "Auto",
                $(go.Shape, "RoundedRectangle",
                    { fill: null, stroke: "dodgerblue", strokeWidth: 3 }),
                $(go.Placeholder)
            );

        // HTML 문서 로드가 완료된 후 init 함수 실행
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
