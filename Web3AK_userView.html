<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3AK 대시보드</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Google Inter Font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        html, body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: #f3f4f6; }
        
        /* Animation for loading icons */
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* D3 Tree Styles */
        #tree-container svg { cursor: grab; background-color: #ffffff; border-radius: 0.75rem; }
        .node text { font-family: 'Inter', sans-serif; pointer-events: none; }

        /* Table row cursor */
        #data-table tbody tr { cursor: pointer; }
        
        /* Modal Transitions */
        .modal-enter { opacity: 0; transform: translateY(20px) scale(0.95); }
        .modal-enter-active { opacity: 1; transform: translateY(0) scale(1); }
        .modal-exit { opacity: 1; transform: translateY(0) scale(1); }
        .modal-exit-active { opacity: 0; transform: translateY(20px) scale(0.95); }

        /* Bottom Sheet (Mobile Modal) Transitions */
        .bottom-sheet-enter { transform: translateY(100%); }
        .bottom-sheet-enter-active { transform: translateY(0); }
        .bottom-sheet-exit { transform: translateY(0); }
        .bottom-sheet-exit-active { transform: translateY(100%); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-6 lg:p-8">
    <div id="app" class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-extrabold text-indigo-700 flex items-center">
                <i data-lucide="network" class="w-8 h-8 mr-3 text-indigo-500"></i>
                Web3AK 조직도
            </h1>
            <p class="text-gray-500 mt-1 text-sm sm:text-base">Google Sheets 기반 실시간 조직 구조 및 지표</p>
        </header>
        
        <!-- Status Message Area -->
        <div id="status-message" class="hidden transition-opacity duration-300"></div>

        <!-- Control Panel -->
        <div class="bg-white p-4 sm:p-5 rounded-xl shadow-lg mb-6">
            <div class="flex flex-col sm:flex-row sm:items-end gap-4"> 
                
                <!-- Search Group -->
                <div class="flex-grow flex items-end gap-2">
                    <div class="flex-shrink-0 w-20"> 
                        <label for="search-field" class="block text-xs font-medium text-gray-700 mb-1">검색 항목</label>
                        <div class="relative">
                            <select id="search-field" class="w-full border-gray-300 rounded-lg text-sm shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition appearance-none py-2.5 pl-3 pr-8">
                                <option value="유저_ID">ID</option> 
                                <option value="유저_이름">성명</option>
                                <option value="연락처">연락처</option>
                            </select>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 absolute right-2.5 top-1/2 transform -translate-y-1/2 pointer-events-none"></i>
                        </div>
                    </div>
                    
                    <div class="relative w-full"> 
                        <label for="search-input" class="block text-xs font-medium text-gray-700 mb-1">검색어</label>
                        <input type="text" id="search-input" placeholder="지갑주소 뒤 6자리" class="w-full border-gray-300 rounded-lg text-sm shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition py-2.5 pl-10 pr-4">
                        <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2 mt-0.5"></i>
                    </div>
                </div>

                <!-- Action Group -->
                <div class="flex items-center gap-2 sm:gap-3 flex-shrink-0">
                    <div class="flex items-center space-x-2 border-r border-gray-200 pr-3 sm:pr-4">
                         <label for="view-toggle" class="text-sm font-medium text-gray-700 select-none">조직도</label>
                         <input type="checkbox" id="view-toggle" class="relative peer shrink-0 appearance-none w-11 h-6 bg-gray-200 rounded-full transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 cursor-pointer after:content-[''] after:w-5 after:h-5 after:bg-white after:rounded-full after:shadow-md after:absolute after:left-0.5 after:top-0.5 after:transition-transform after:duration-200 after:ease-in-out peer-checked:bg-indigo-600 peer-checked:after:translate-x-full">
                         <label for="view-toggle" class="text-sm font-medium text-gray-700 select-none">지표</label>
                    </div>

                    <button id="refresh-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md transition duration-200 ease-in-out flex items-center justify-center disabled:opacity-60 disabled:cursor-not-allowed whitespace-nowrap text-sm">
                        <i id="refresh-icon" data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                        새로고침
                    </button>
                </div>

            </div>
        </div>

        <!-- Content Area -->
        <div id="loading-state" class="text-center py-20">
            <i data-lucide="loader-2" class="spin w-12 h-12 text-indigo-500 mx-auto mb-4"></i>
            <p class="text-indigo-600 font-medium text-lg">데이터를 불러오는 중입니다...</p>
        </div>

        <div id="data-container" class="mt-6 hidden">
            <!-- Table View -->
            <div id="table-view" class="bg-white rounded-xl shadow-lg p-4 overflow-x-auto hidden">
                <div class="overflow-y-auto max-h-[calc(100vh-320px)]">
                    <table id="data-table" class="min-w-full divide-y divide-gray-200"> 
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr id="table-header"></tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Tree View -->
            <div id="tree-view" class="relative">
                 <div id="tree-container" class="w-full h-[65vh] sm:h-[70vh] bg-white rounded-xl shadow-lg"></div>
                 <!-- D3 Control Buttons -->
                 <div class="absolute top-4 right-4 flex flex-col gap-2 z-10">
                    <button id="zoom-in-btn" class="bg-white/80 backdrop-blur-sm hover:bg-gray-100 text-gray-700 p-2 rounded-full shadow-md transition"><i data-lucide="zoom-in" class="w-5 h-5"></i></button>
                    <button id="zoom-out-btn" class="bg-white/80 backdrop-blur-sm hover:bg-gray-100 text-gray-700 p-2 rounded-full shadow-md transition"><i data-lucide="zoom-out" class="w-5 h-5"></i></button>
                    <button id="reset-view-btn" class="bg-white/80 backdrop-blur-sm hover:bg-gray-100 text-gray-700 p-2 rounded-full shadow-md transition"><i data-lucide="locate" class="w-5 h-5"></i></button>
                 </div>
            </div>
        </div>
        
    </div>

    <!-- Detail Info Modal/Bottom Sheet -->
    <div id="detail-modal-overlay" class="fixed inset-0 bg-black/30 z-40 hidden transition-opacity duration-300"></div>
    <div id="detail-modal" class="fixed z-50 hidden transition-all duration-300 w-full max-w-md p-6 bg-white rounded-t-2xl sm:rounded-xl shadow-2xl left-1/2 bottom-0 sm:bottom-auto sm:top-1/2 -translate-x-1/2 sm:-translate-y-1/2">
        <!-- Content will be injected here -->
    </div>


    <script>
        // =========================================================
        // INITIALIZATION & CONFIG
        // =========================================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxutUIMVFENC6qT4kLeTUgkZxw31Mcu8mD_pHw5mMDj3OPixX-WycckTq3jl2wsepzjqw/exec";

        const DOM = {
            loadingState: document.getElementById('loading-state'),
            dataContainer: document.getElementById('data-container'),
            tableView: document.getElementById('table-view'),
            treeView: document.getElementById('tree-view'),
            tableHeader: document.getElementById('table-header'),
            tableBody: document.getElementById('table-body'),
            treeContainer: document.getElementById('tree-container'),
            statusMessage: document.getElementById('status-message'),
            refreshButton: document.getElementById('refresh-button'),
            refreshIcon: document.getElementById('refresh-icon'),
            searchInput: document.getElementById('search-input'),
            searchField: document.getElementById('search-field'),
            viewToggle: document.getElementById('view-toggle'),
            detailModal: document.getElementById('detail-modal'),
            detailModalOverlay: document.getElementById('detail-modal-overlay'),
            zoomInBtn: document.getElementById('zoom-in-btn'),
            zoomOutBtn: document.getElementById('zoom-out-btn'),
            resetViewBtn: document.getElementById('reset-view-btn'),
        };

        const appState = {
            rawData: [],
            filteredData: [],
            isTableView: false,
            currentSort: { key: '', direction: 'none' }, // 'asc', 'desc', 'none'
            searchTerm: '',
            searchField: '유저_ID',
            d3: {
                zoom: null,
                svg: null,
                g: null,
                initialTransform: null
            }
        };

        window.onload = () => {
             lucide.createIcons();
             initialize();
        };

        function initialize() {
            addEventListeners();
            // 초기 뷰 설정 (체크박스 상태에 따라)
            appState.isTableView = DOM.viewToggle.checked;
            appState.searchField = DOM.searchField.value;
            updatePlaceholder();
            fetchData(false); // false: not a force refresh
        }

        // =========================================================
        // API & DATA HANDLING
        // =========================================================
        async function fetchData(isForceRefresh = false) {
            DOM.loadingState.classList.remove('hidden');
            DOM.dataContainer.classList.add('hidden');
            DOM.refreshButton.disabled = true;
            DOM.refreshIcon.classList.add('spin');

            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(`API Error: ${data.error}`);
                
                appState.rawData = data.map(user => ({
                    ...user,
                    '직속_하위_수': Number(user['직속_하위_수']),
                    '총_하위_수': Number(user['총_하위_수']),
                }));

                DOM.dataContainer.classList.remove('hidden');
                applyFiltersAndSort();
                
                if (isForceRefresh) {
                    showTransientMessage('데이터를 성공적으로 업데이트했습니다.', 'success');
                }
            } catch (error) {
                console.error("Error fetching data:", error);
                showTransientMessage(`데이터 로드 실패: ${error.message}`, 'error');
                DOM.dataContainer.classList.add('hidden');
            } finally {
                DOM.loadingState.classList.add('hidden');
                DOM.refreshButton.disabled = false;
                DOM.refreshIcon.classList.remove('spin');
            }
        }
        
        // =========================================================
        // STATE & FILTERING
        // =========================================================
        function applyFiltersAndSort() {
            let data = [...appState.rawData];

            // 1. Filter by search term
            if (appState.searchTerm) {
                data = data.filter(user => {
                    const value = String(user[appState.searchField] || '').toLowerCase();
                    return value.includes(appState.searchTerm);
                });
            }

            // 2. Sort data
            const { key, direction } = appState.currentSort;
            if (key && direction !== 'none') {
                const isNumeric = ['직속_하위_수', '총_하위_수'].includes(key);
                data.sort((a, b) => {
                    const valA = a[key];
                    const valB = b[key];
                    if (direction === 'asc') {
                        return isNumeric ? valA - valB : String(valA).localeCompare(String(valB));
                    } else {
                        return isNumeric ? valB - valA : String(valB).localeCompare(String(valA));
                    }
                });
            }
            
            appState.filteredData = data;
            renderCurrentView();
        }
        
        function handleSort(key) {
            const { currentSort } = appState;
            if (currentSort.key === key) {
                if (currentSort.direction === 'asc') currentSort.direction = 'desc';
                else if (currentSort.direction === 'desc') {
                    currentSort.key = '';
                    currentSort.direction = 'none';
                }
            } else {
                currentSort.key = key;
                currentSort.direction = 'asc';
            }
            applyFiltersAndSort();
        }
        
        function updatePlaceholder() {
            const placeholders = {
                '유저_ID': '지갑주소 뒤 6자리',
                '유저_이름': '이름으로 검색',
                '연락처': '연락처로 검색'
            };
            DOM.searchInput.placeholder = placeholders[appState.searchField] || '검색...';
        }

        // =========================================================
        // UI RENDERING
        // =========================================================
        function renderCurrentView() {
            if (appState.isTableView) {
                DOM.tableView.classList.remove('hidden');
                DOM.treeView.classList.add('hidden');
                renderTable();
            } else {
                DOM.tableView.classList.add('hidden');
                DOM.treeView.classList.remove('hidden');
                renderTree();
            }
            lucide.createIcons();
        }

        function renderTable() {
            const headers = [
                { key: '유저_ID', label: 'ID', sortable: true },
                { key: '유저_이름', label: '성명', sortable: true },
                { key: '연락처', label: '연락처', sortable: false },
                { key: '직속_하위_수', label: '직대', sortable: true },
                { key: '총_하위_수', label: '총계', sortable: true }
            ];

            DOM.tableHeader.innerHTML = headers.map(({ key, label, sortable }) => {
                let icon = '';
                if (sortable) {
                    if (appState.currentSort.key === key) {
                        icon = appState.currentSort.direction === 'asc' 
                            ? `<i data-lucide="arrow-up" class="w-4 h-4 text-indigo-600"></i>` 
                            : `<i data-lucide="arrow-down" class="w-4 h-4 text-indigo-600"></i>`;
                    } else {
                        icon = `<i data-lucide="arrow-up-down" class="w-4 h-4 text-gray-400"></i>`;
                    }
                }
                const classes = sortable ? 'cursor-pointer hover:bg-gray-100' : '';
                return `
                    <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider ${classes}" onclick="${sortable ? `handleSort('${key}')` : ''}">
                        <div class="flex items-center gap-2">${label} ${icon}</div>
                    </th>`;
            }).join('');
            
            if (appState.filteredData.length === 0) {
                DOM.tableBody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-10 text-gray-500">검색 결과가 없습니다.</td></tr>`;
            } else {
                DOM.tableBody.innerHTML = appState.filteredData.map(user => {
                    return `
                        <tr class="hover:bg-indigo-50 transition" onclick="showDetailModal('${user['유저_ID']}')">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${user['유저_ID']}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${user['유저_이름']}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${user['연락처']}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-center">${user['직속_하위_수']}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-center">${user['총_하위_수']}</td>
                        </tr>`;
                }).join('');
            }
            lucide.createIcons();
        }
        
        function renderTree() {
            DOM.treeContainer.innerHTML = '';
            if (appState.rawData.length === 0) return;

            const dataMap = appState.rawData.reduce((map, node) => {
                map[node['본인_지갑_주소']] = { ...node, children: [] };
                return map;
            }, {});

            const roots = [];
            appState.rawData.forEach(node => {
                const parentAddr = node['상위_노드_지갑_주소'];
                if (parentAddr && dataMap[parentAddr] && parentAddr !== node['본인_지갑_주소']) {
                    dataMap[parentAddr].children.push(dataMap[node['본인_지갑_주소']]);
                } else {
                    roots.push(dataMap[node['본인_지갑_주소']]);
                }
            });

            const rootData = roots.length > 1 ? { '유저_이름': '전체 조직', '유저_ID': 'ROOT', children: roots } : roots[0];
            if (!rootData) {
                 DOM.treeContainer.innerHTML = '<p class="text-center py-10 text-gray-500">유효한 루트 노드를 찾을 수 없습니다.</p>';
                 return;
            }

            const width = DOM.treeContainer.clientWidth;
            const height = DOM.treeContainer.clientHeight;
            
            const treeLayout = d3.tree().nodeSize([170, 140]);
            const root = d3.hierarchy(rootData);
            const treeData = treeLayout(root);

            appState.d3.svg = d3.select(DOM.treeContainer).append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", `0 0 ${width} ${height}`);
                
            appState.d3.g = appState.d3.svg.append("g");

            appState.d3.zoom = d3.zoom().scaleExtent([0.1, 3]).on("zoom", (event) => {
                appState.d3.g.attr("transform", event.transform);
            });
            
            appState.d3.svg.call(appState.d3.zoom);

            const initialX = width / 2;
            const initialY = 100;
            appState.d3.initialTransform = d3.zoomIdentity.translate(initialX, initialY).scale(0.8);
            appState.d3.svg.call(appState.d3.zoom.transform, appState.d3.initialTransform);


            appState.d3.g.selectAll(".link")
                .data(treeData.links()).enter().append("path")
                .attr("fill", "none").attr("stroke", "#d1d5db").attr("stroke-width", 2)
                .attr("d", d3.linkVertical().x(d => d.x).y(d => d.y));

            const node = appState.d3.g.selectAll(".node")
                .data(treeData.descendants()).enter().append("g")
                .attr("transform", d => `translate(${d.x},${d.y})`)
                .attr("cursor", d => d.data['유저_ID'] === 'ROOT' ? 'default' : 'pointer')
                .on("click", (event, d) => {
                    if (d.data['유저_ID'] !== 'ROOT') showDetailModal(d.data['유저_ID']);
                });

            const nodeWidth = 150, nodeHeight = 90;
            node.append("rect")
                .attr("width", nodeWidth).attr("height", nodeHeight)
                .attr("x", -nodeWidth / 2).attr("y", -nodeHeight / 2)
                .attr("rx", 8).attr("ry", 8)
                .attr("fill", d => {
                    const value = String(d.data[appState.searchField] || '').toLowerCase();
                    return appState.searchTerm && value.includes(appState.searchTerm) ? '#e0e7ff' : '#ffffff';
                })
                .attr("stroke", d => d.data['유저_ID'] === 'ROOT' ? "#a5b4fc" : "#6366f1")
                .attr("stroke-width", 2.5);

            node.append("text").attr("dy", "-22").attr("text-anchor", "middle").style("font-size", "15px").style("font-weight", "800").attr("fill", "#111827").text(d => d.data['유저_이름']);
            node.append("text").attr("dy", "0").attr("text-anchor", "middle").style("font-size", "13px").attr("fill", "#4f46e5").text(d => d.data['유저_ID'] !== 'ROOT' ? d.data['유저_ID'] : '');
            node.append("text").attr("dy", "25").attr("text-anchor", "middle").style("font-size", "12px").attr("fill", "#4b5563")
                .text(d => d.data['유저_ID'] !== 'ROOT' ? `직속:${d.data['직속_하위_수']} / 총:${d.data['총_하위_수']}` : `총원: ${appState.rawData.length}`);
        }
        
        function showTransientMessage(message, type = 'info') {
            const colors = {
                success: 'bg-green-100 text-green-800',
                error: 'bg-red-100 text-red-800',
                info: 'bg-blue-100 text-blue-800'
            };
            DOM.statusMessage.innerHTML = `<div class="p-4 rounded-lg text-sm font-medium ${colors[type]}">${message}</div>`;
            DOM.statusMessage.classList.remove('hidden', 'opacity-0');
            DOM.statusMessage.classList.add('opacity-100');

            setTimeout(() => {
                DOM.statusMessage.classList.remove('opacity-100');
                DOM.statusMessage.classList.add('opacity-0');
                setTimeout(() => DOM.statusMessage.classList.add('hidden'), 300);
            }, 5000);
        }

        // =========================================================
        // DETAIL MODAL
        // =========================================================
        function showDetailModal(userId) {
            const user = appState.rawData.find(u => u['유저_ID'] === userId);
            if (!user) return;

            const content = `
                <button onclick="hideDetailModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                <h3 class="text-xl font-bold text-indigo-700 mb-1">${user['유저_이름']}</h3>
                <p class="text-sm text-gray-500 mb-6">${user['유저_ID']}</p>
                <div class="space-y-4 text-sm">
                    <div>
                        <label class="font-semibold text-gray-800 block mb-1">본인 지갑주소</label>
                        <p class="text-indigo-600 bg-indigo-50 p-2 rounded-md break-all">${user['본인_지갑_주소']}</p>
                    </div>
                    <div>
                        <label class="font-semibold text-gray-800 block mb-1">상위 지갑주소</label>
                        <p class="text-gray-600 bg-gray-50 p-2 rounded-md break-all">${user['상위_노드_지갑_주소'] || '없음'}</p>
                    </div>
                     <div>
                        <label class="font-semibold text-gray-800 block mb-1">연락처</label>
                        <p class="text-gray-600">${user['연락처'] || '정보 없음'}</p>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-200 text-sm flex justify-around">
                    <div class="text-center"><span class="font-bold block text-lg text-indigo-600">${user['직속_하위_수']}</span><span class="text-xs text-gray-500">직속 하위</span></div>
                    <div class="text-center"><span class="font-bold block text-lg text-indigo-600">${user['총_하위_수']}</span><span class="text-xs text-gray-500">총 하위</span></div>
                </div>
            `;
            DOM.detailModal.innerHTML = content;
            lucide.createIcons();

            DOM.detailModalOverlay.classList.remove('hidden');
            DOM.detailModal.classList.remove('hidden');
            
            // For transition effect
            requestAnimationFrame(() => {
                 DOM.detailModalOverlay.classList.add('opacity-100');
                 DOM.detailModal.classList.add(window.innerWidth < 640 ? 'bottom-sheet-enter-active' : 'modal-enter-active');
                 DOM.detailModal.classList.remove(window.innerWidth < 640 ? 'bottom-sheet-enter' : 'modal-enter');
            });
        }
        
        function hideDetailModal() {
            DOM.detailModalOverlay.classList.remove('opacity-100');
            DOM.detailModal.classList.add(window.innerWidth < 640 ? 'bottom-sheet-exit-active' : 'modal-exit-active');
            DOM.detailModal.classList.remove(window.innerWidth < 640 ? 'bottom-sheet-exit' : 'modal-exit');
            
            setTimeout(() => {
                DOM.detailModalOverlay.classList.add('hidden');
                DOM.detailModal.classList.add('hidden');
                DOM.detailModal.className = 'fixed z-50 hidden transition-all duration-300 w-full max-w-md p-6 bg-white rounded-t-2xl sm:rounded-xl shadow-2xl left-1/2 bottom-0 sm:bottom-auto sm:top-1/2 -translate-x-1/2 sm:-translate-y-1/2'; // Reset classes
                DOM.detailModal.innerHTML = '';
            }, 300);
        }

        // =========================================================
        // EVENT HANDLERS
        // =========================================================
        function addEventListeners() {
            DOM.refreshButton.addEventListener('click', () => fetchData(true));
            
            DOM.searchInput.addEventListener('input', (e) => {
                appState.searchTerm = e.target.value.toLowerCase().trim();
                applyFiltersAndSort();
            });

            DOM.searchField.addEventListener('change', (e) => {
                appState.searchField = e.target.value;
                updatePlaceholder();
                applyFiltersAndSort();
            });

            DOM.viewToggle.addEventListener('change', (e) => {
                appState.isTableView = e.target.checked;
                renderCurrentView();
            });
            
            DOM.detailModalOverlay.addEventListener('click', hideDetailModal);
            
            // D3 Controls
            DOM.zoomInBtn.addEventListener('click', () => {
                appState.d3.svg.transition().duration(250).call(appState.d3.zoom.scaleBy, 1.3);
            });
            DOM.zoomOutBtn.addEventListener('click', () => {
                appState.d3.svg.transition().duration(250).call(appState.d3.zoom.scaleBy, 0.7);
            });
            DOM.resetViewBtn.addEventListener('click', () => {
                if(appState.d3.initialTransform) {
                    appState.d3.svg.transition().duration(500).call(appState.d3.zoom.transform, appState.d3.initialTransform);
                }
            });
        }
    </script>
</body>
</html>
